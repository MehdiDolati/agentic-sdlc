 {% extends "base.html" %}
 {% block content %}
 <a href="/ui/plans">← All plans</a>
<h1>Plan</h1>
<div class="subhead">{{ plan["request"] }}</div>
<div class="meta">
    <a href="/ui/settings">Settings</a>
    <form hx-post="/ui/plans/{{ plan['id'] }}/git/branch" hx-target="closest body" hx-swap="beforeend" style="display:inline-block; margin-left:1rem">
      <input type="text" name="branch" placeholder="feature/{{ plan['id'] }}" />
      <button type="submit">Create/Update Branch</button>
    </form>
    <form hx-post="/ui/plans/{{ plan['id'] }}/git/pr" hx-target="closest body" hx-swap="beforeend" style="display:inline-block; margin-left:.5rem">
      <input type="text" name="branch" placeholder="feature/{{ plan['id'] }}" required />
      <input type="text" name="title" placeholder="PR title (optional)" />
      <button type="submit">Open PR</button>
    </form>
</div>
<div class="grid">
  <!-- Run section -->
  <div class="card">
    <h2>Run</h2>
    <div
      hx-get="/ui/plans/{{ plan['id'] }}/sections/run"
      hx-trigger="load"
      hx-target="this"
      hx-swap="outerHTML">
      <div class="meta">Loading…</div>
    </div>
  </div>

  <div class="card">
    <h2>PRD</h2>
    <div
      hx-get="/ui/plans/{{ plan['id'] }}/sections/prd"
      hx-trigger="load"
      hx-target="this"
      hx-swap="outerHTML">
      <div class="meta">Loading…</div>
    </div>
  </div>

  <div class="card">
    <h2>ADR</h2>
    <div
      hx-get="/ui/plans/{{ plan['id'] }}/sections/adr"
      hx-trigger="load"
      hx-target="this"
      hx-swap="outerHTML">
      <div class="meta">Loading…</div>
    </div>
  </div>

  <div class="card">
    <h2>Architecture</h2>
    <div
      hx-get="/ui/plans/{{ plan['id'] }}/sections/architecture"
      hx-trigger="load"
      hx-target="this"
      hx-swap="outerHTML">
      <div class="meta">Loading…</div>
    </div>
  </div>

  <div class="card">
    <h2>Tech Spec</h2>
    <div
      hx-get="/ui/plans/{{ plan['id'] }}/sections/techspec"
      hx-trigger="load"
      hx-target="this"
      hx-swap="outerHTML">
      <div class="meta">Loading…</div>
    </div>
  </div>

  <div id="stories-section"
      class="card"
      hx-get="/ui/plans/{{ plan['id'] }}/sections/stories?page=1"
      hx-trigger="load"
      hx-target="#stories-section"
      hx-swap="outerHTML"
      hx-select="#stories-section">
      <h2>Stories</h2>
      <div class="meta">Loading…</div>
  </div>  
  
  <div class="card">
    <h2>Tasks</h2>
    <div
      hx-get="/ui/plans/{{ plan['id'] }}/sections/tasks"
      hx-trigger="load"
      hx-target="this"
      hx-swap="outerHTML">
      <div class="meta">Loading…</div>
    </div>
  </div>

  <div class="card">
    <h2>OpenAPI</h2>
    <div
      hx-get="/ui/plans/{{ plan['id'] }}/sections/openapi"
      hx-trigger="load"
      hx-target="this"
      hx-swap="outerHTML">
      <div class="meta">Loading…</div>
    </div>
  </div>

  <div class="card">
    <h2>Artifacts</h2>
    <dl class="artifact-list">
      {% if prd_rel %}
      <div class="artifact-row">
        <dt>PRD:</dt>
        <dd>
          <a class="artifact-path pill"
             href="/ui/artifact?path={{ prd_rel | urlencode }}"
             target="_blank" rel="noopener">{{ prd_rel }}</a>
          <button type="button" class="copy-btn"
                  onclick="navigator.clipboard.writeText('{{ prd_rel }}')">Copy</button>
        </dd>
      </div>
      {% endif %}

      {% if adr_rel %}
      <div class="artifact-row">
        <dt>ADR:</dt>
        <dd>
          <a class="artifact-path pill"
             href="/ui/artifact?path={{ adr_rel | urlencode }}"
             target="_blank" rel="noopener">{{ adr_rel }}</a>
          <button type="button" class="copy-btn"
                  onclick="navigator.clipboard.writeText('{{ adr_rel }}')">Copy</button>
        </dd>
      </div>
      {% endif %}
	
      {% if tasks_rel %}
      <div class="artifact-row">
        <dt>Tasks:</dt>
        <dd>
          <a class="artifact-path pill"
             href="/ui/artifact?path={{ tasks_rel | urlencode }}"
             target="_blank" rel="noopener">{{ tasks_rel }}</a>
          <button type="button" class="copy-btn"
                  onclick="navigator.clipboard.writeText('{{ tasks_rel }}')">Copy</button>
        </dd>
      </div>
      {% endif %}

      {% if openapi_rel %}
      <div class="artifact-row">
        <dt>OpenAPI:</dt>
        <dd>
          <a class="artifact-path pill"
             href="/ui/artifact?path={{ openapi_rel | urlencode }}"
             target="_blank" rel="noopener">{{ openapi_rel }}</a>
          <button type="button" class="copy-btn"
                  onclick="navigator.clipboard.writeText('{{ openapi_rel }}')">Copy</button>
        </dd>
      </div>
      {% endif %}
    </dl>
  </div>
</div>
{% endblock %}